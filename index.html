<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تسجيل الزوار</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:2rem;direction:rtl}
    button{padding:.6rem 1rem;font-size:1rem}
    .note{color:#666;margin-top:.5rem}
  </style>
</head>
<body>
  <h1>سجل الزيارات (اختبار)</h1>
  <p>اضغط الزر أدناه لإرسال معلومات الزائر إلى الخادم الذي يقوم بإعادة توجيه الرسالة إلى Discord (الـ webhook مخفي في ملف <code>.env</code> على الخادم).</p>

  <button id="logBtn">سجل زيارة</button>
  <p id="status" style="margin-top:1rem;color:#444"></p>
  <p class="note">ملاحظة أمنيّة: الـ webhook محفوظ في الخادم فقط؛ لا تُضعه في كود الواجهة.</p>

  <script>
  async function logVisitor() {
    const statusEl = document.getElementById('status');
    statusEl && (statusEl.textContent = 'جاري جلب معلومات الزائر...');

    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      const ip = data.ip;
      const dateTime = new Date().toLocaleString();
      const payload = { ip, dateTime, userAgent: navigator.userAgent };

      const r = await fetch('/log-visit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!r.ok) {
        const text = await r.text().catch(() => '');
        statusEl && (statusEl.textContent = `فشل الإرسال: ${r.status} ${text}`);
        console.warn('Server response', r.status, text);
      } else {
        statusEl && (statusEl.textContent = 'تم الإرسال بنجاح — تحقق من قناة Discord');
        console.log('Visit logged:', payload);
      }
    } catch (err) {
      console.error(err);
      statusEl && (statusEl.textContent = 'حدث خطأ. افتح الكونسول للاطلاع على التفاصيل.');
    }
  }

  document.getElementById('logBtn').addEventListener('click', logVisitor);
  </script>
</body>
</html>
